config {
    type: "table",
    schema: "raw",
    name: "hubspot_tickets_raw_dataform",
    description: "Time formats are corrected for all the timestamp fields ",
    tags:["tickets_pipeline"]
}
select
id as ticket_id,
createdAt AS created_at,
(safe_cast(properties_time_to_close as int64) / 1000.0 / 60.0 / 60.0) as time_to_close,
REGEXP_REPLACE(properties_hs_all_associated_contact_phones, r'[^0-9]', '') as hs_all_associated_contact_phones,
updatedAt AS updated_at,
archived,
json_value(properties,'$.archived_at') AS archived_at,
json_value(properties,'$.associations') AS associations,
properties_account_name as account_name,
safe_cast(properties_amount_refunded as float64) as amount_refunded,
properties_app_screen AS app_screen,
properties_bank_name AS bank_name,
properties_case_status AS case_status,
lower(properties_client_solution_type) as client_solution_type,
-- closed_date,
safe_cast(properties_closed_date as timestamp) as closed_date,
properties_closing_sales_owner AS closing_sales_owner,
properties_closing_agent AS closing_agent,
properties_complainee AS complainee,
properties_created_by AS created_by,
properties_createdate AS createdate,
properties_cx___poc  as cx_poc,
properties_cx_resolution_description AS cx_resolution_description,
properties_cx_status AS cx_status,
properties_first_agent_reply_date AS first_agent_reply_date,
json_value(properties,'$.hs_all_assigned_business_unit_ids') AS hs_all_assigned_business_unit_ids,
properties_hs_all_associated_contact_companies AS hs_all_associated_contact_companies,
properties_hs_all_associated_contact_emails AS hs_all_associated_contact_emails,
properties_hs_all_associated_contact_firstnames AS hs_all_associated_contact_firstnames,
properties_hs_all_associated_contact_lastnames AS hs_all_associated_contact_lastnames,
properties_hs_all_associated_contact_mobilephones AS hs_all_associated_contact_mobilephones,
properties_hs_all_conversation_mentions AS hs_all_conversation_mentions,
properties_hs_applied_sla_rule_config_id AS hs_applied_sla_rule_config_id,
properties_hs_assigned_team_ids AS hs_assigned_team_ids,
properties_hs_assignment_method AS hs_assignment_method,
properties_hs_auto_generated_from_thread_id AS hs_auto_generated_from_thread_id,
properties_hs_conversations_originating_message_id AS hs_conversations_originating_message_id,
properties_hs_conversations_originating_thread_id AS hs_conversations_originating_thread_id,
properties_hs_created_by_user_id AS hs_created_by_user_id,
properties_hs_createdate AS hs_createdate,
properties_hs_custom_inbox AS hs_custom_inbox,
properties_hs_date_entered_1 AS hs_date_entered_1,
properties_hs_date_entered_109390109 AS hs_date_entered_109390109,
properties_hs_date_entered_120121874 AS hs_date_entered_120121874,
properties_hs_date_entered_2 AS hs_date_entered_2,
properties_hs_date_entered_3 AS hs_date_entered_3,
properties_hs_date_entered_4 AS hs_date_entered_4,
properties_hs_date_exited_1 AS hs_date_exited_1,
properties_hs_date_exited_109390109 AS hs_date_exited_109390109,
properties_hs_date_exited_120121874 AS hs_date_exited_120121874,
properties_hs_date_exited_2 AS hs_date_exited_2,
properties_hs_date_exited_3 AS hs_date_exited_3,
properties_hs_date_exited_4 AS hs_date_exited_4,
properties_hs_external_object_ids AS hs_external_object_ids,
json_value(properties,'$.hs_feedback_last_ces_follow_up') AS hs_feedback_last_ces_follow_up,
json_value(properties,'$.hs_feedback_last_ces_rating') AS hs_feedback_last_ces_rating,
json_value(properties,'$.hs_feedback_last_survey_date') AS hs_feedback_last_survey_date,
properties_hs_file_upload AS hs_file_upload,
properties_hs_first_agent_message_sent_at AS hs_first_agent_message_sent_at,
properties_hs_helpdesk_sort_timestamp AS hs_helpdesk_sort_timestamp,
properties_hs_in_helpdesk AS hs_in_helpdesk,
properties_hs_inbox_id AS hs_inbox_id,
properties_hs_is_visible_in_help_desk AS hs_is_visible_in_help_desk,
properties_hs_last_email_activity AS hs_last_email_activity,
properties_hs_last_email_date AS hs_last_email_date,
properties_hs_last_message_from_visitor AS hs_last_message_from_visitor,
properties_hs_last_message_received_at AS hs_last_message_received_at,
properties_hs_last_message_sent_at AS hs_last_message_sent_at,
properties_hs_lastactivitydate AS hs_lastactivitydate,
properties_hs_lastcontacted AS hs_lastcontacted,
properties_hs_lastmodifieddate AS hs_lastmodifieddate,
properties_hs_latest_message_seen_by_agent_ids AS hs_latest_message_seen_by_agent_ids,
properties_hs_merged_object_ids AS hs_merged_object_ids,
properties_hs_most_relevant_sla_status AS hs_most_relevant_sla_status,
properties_hs_most_relevant_sla_type AS hs_most_relevant_sla_type,
properties_hs_msteams_message_id AS hs_msteams_message_id,
properties_hs_nextactivitydate AS hs_nextactivitydate,
properties_hs_num_associated_companies AS hs_num_associated_companies,
properties_hs_num_associated_conversations AS hs_num_associated_conversations,
properties_hs_num_times_contacted AS hs_num_times_contacted,
properties_hs_object_id AS hs_object_id,
properties_hs_object_source AS hs_object_source,
properties_hs_object_source_id AS hs_object_source_id,
properties_hs_object_source_label AS hs_object_source_label,
properties_hs_object_source_user_id AS hs_object_source_user_id,
properties_hs_originating_channel_instance_id AS hs_originating_channel_instance_id,
properties_hs_originating_email_engagement_id AS hs_originating_email_engagement_id,
properties_hs_originating_generic_channel_id AS hs_originating_generic_channel_id,
properties_hs_pinned_engagement_id AS hs_pinned_engagement_id,
case when properties_hs_pipeline='0' then 'support_pipeline'
else null end as hs_pipeline,
case when properties_hs_pipeline_stage = '1' then 'New'
     when properties_hs_pipeline_stage = '2' then 'support_checkpoint'
     when properties_hs_pipeline_stage = '120121874' then 'tutor_matchmaking'
     when properties_hs_pipeline_stage = '109390109' then 'pending_refund'
     when properties_hs_pipeline_stage = '4' then 'closed'
     when properties_hs_pipeline_stage = '247535618' then 'Sales Checkpoint'
     when properties_hs_pipeline_stage = '247539459' then 'Replacements'
     else null end as hs_pipeline_stage,
properties_hs_primary_company AS hs_primary_company,
properties_hs_primary_company_id AS hs_primary_company_id,
properties_hs_primary_company_name AS hs_primary_company_name,
properties_hs_read_only AS hs_read_only,
properties_hs_resolution AS hs_resolution,
properties_hs_seen_by_agent_ids AS hs_seen_by_agent_ids,
json_value(properties,'$.hs_source_object_id') AS hs_source_object_id,
properties_hs_tag_ids AS hs_tag_ids,
properties_hs_thread_ids_to_restore AS hs_thread_ids_to_restore,
lower(properties_hs_ticket_category) as hs_ticket_category,
properties_hs_ticket_id AS hs_ticket_id,
properties_hs_ticket_priority AS hs_ticket_priority,
properties_hs_time_in_1 AS hs_time_in_1,
properties_hs_time_in_109390109 AS hs_time_in_109390109,
properties_hs_time_in_120121874 AS hs_time_in_120121874,
properties_hs_time_in_2 AS hs_time_in_2,
properties_hs_time_in_3 AS hs_time_in_3,
properties_hs_time_in_4 AS hs_time_in_4,
json_value(properties,'$.hs_time_to_close_sla_at') AS hs_time_to_close_sla_at,
properties_content AS content,
properties_hs_all_accessible_team_ids AS hs_all_accessible_team_ids,
properties_hs_all_owner_ids AS hs_all_owner_ids,
properties_hs_all_team_ids AS hs_all_team_ids,
properties_hs_sales_email_last_replied AS hs_sales_email_last_replied,
json_value(properties,'$.hs_time_to_close_sla_status') AS hs_time_to_close_sla_status,
json_value(properties,'$.hs_time_to_first_response_sla_at') AS hs_time_to_first_response_sla_at,
json_value(properties,'$.hs_time_to_first_response_sla_status') AS hs_time_to_first_response_sla_status,
json_value(properties,'$.hs_time_to_next_response_sla_at') AS hs_time_to_next_response_sla_at,
json_value(properties,'$.hs_time_to_next_response_sla_status') AS hs_time_to_next_response_sla_status,
properties_hs_unique_creation_key AS hs_unique_creation_key,
properties_hs_updated_by_user_id AS hs_updated_by_user_id,
properties_hs_user_ids_of_all_notification_followers AS hs_user_ids_of_all_notification_followers,
properties_hs_user_ids_of_all_notification_unfollowers AS hs_user_ids_of_all_notification_unfollowers,
properties_hs_user_ids_of_all_owners AS hs_user_ids_of_all_owners,
properties_hs_was_imported AS hs_was_imported,
properties_hubspot_owner_assigneddate AS hubspot_owner_assigneddate,
properties_hubspot_owner_id AS hubspot_owner_id,
properties_hubspot_team_id AS hubspot_team_id,
properties_iban AS iban,
properties_last_engagement_date AS last_engagement_date,
properties_last_reply_date AS last_reply_date,
properties_location AS location,
properties_notes_last_contacted AS notes_last_contacted,
properties_notes_last_updated AS notes_last_updated,
properties_notes_next_activity_date AS notes_next_activity_date,
properties_nps_follow_up_answer AS nps_follow_up_answer,
properties_nps_follow_up_question_version AS nps_follow_up_question_version,
properties_nps_score AS nps_score,
properties_num_contacted_notes AS num_contacted_notes,
properties_num_notes AS num_notes,
safe_cast(properties_number_of_hours_refunded as float64) as number_of_hours_refunded,
properties_preferred_schedule AS preferred_schedule,
properties_qa_reflection AS qa_reflection,
properties_refund_date AS refund_date,
properties_refund_percentage AS refund_percentage,
properties_refund_reason AS refund_reason,
properties_refund_requested AS refund_requested,
properties_refunded_session_type AS refunded_session_type,
properties_replacement_type AS replacement_type,
properties_reporting_agent_ AS reporting_agent_,
properties_source_ref AS source_ref,
properties_source_thread_id AS source_thread_id,
properties_source_type AS source_type,
lower(properties_subject) as ticket_name,
properties_submitted_by AS submitted_by,
properties_submitted_date AS submitted_date,
properties_tags AS tags,
properties_tc__poc as tc_poc,
properties_tc_resolution_description AS tc_resolution_description,
lower(properties_ticket_type) as ticket_type,
properties_time_to_first_agent_reply as time_to_first_agent_reply,
case 
when properties_tutor_matchmaking = 'Tutor Replacement' then 'Tutor Replacement Requested - Active Packages'
else properties_tutor_matchmaking
end as tutor_matchmaking_reason,
properties_tutor_resolution_type AS tutor_resolution_type,
properties_tutor_ticket_status AS tutor_ticket_status,
properties_tutor_replacement_category AS tutor_replacement_category,
properties_tutor_replacement_reason AS tutor_replacement_reason,
from 
al-gooru.hubspot.hubspot_tickets
-- where closed_date != ""
-- where created_at IS NOT NULL AND updated_at IS NOT NULL